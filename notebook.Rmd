---
title: "BDA-project"
output: pdf_document
---

# Loaded packages

```{r, echo=TRUE}
library(tidyr)
library(dplyr)
library(rstan)
library(rstanarm)
library(bayesplot)
library(aaltobda)
options(mc.cores = parallel::detectCores())
library(loo)
library(ggplot2)
library(gridExtra)
library(bayesplot)
```

# Introduction

// this part has to be inviting xD
// General talk about Finalnd having high rates of domestic violence, need to raise awareness, etc.

// Main topic/purpose of the project/notebook.

// Present outline of the notebook 

// structure and organization has to be logical

## Data description

## Analysis problem

## Models

// add a clear list of models

### Model 1

```{r}
data = read.csv("dataset.csv", header = TRUE, sep=";")
data
```

```{r}
ageGroups <- unique(data$Victim.s.age)
grouped_data <- c()


data_for_age_group <- filter(data, Victim.s.age == ageGroups[1])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[2])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[3])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[4])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[5])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[6])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[7])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[8])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[9])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[10])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[11])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

```

```{r}
data_for_age_group <- filter(data, Victim.s.age == ageGroups[7])
fit_lin <- stan_glm(Number.of.victims ~ Year, data = data_for_age_group , family="poisson",
                refresh=1000, iter=1000, chains=4, seed=583829)
print(fit_lin)
```

```{r}
x_predict <- seq(2009,2020)
N_predict <- length(x_predict)
y_predict <- posterior_predict(fit_lin, newdata=data.frame(Year=x_predict))
mu <- apply(t(y_predict), 1, quantile, c(0.05, 0.5, 0.95)) %>%
  t() %>% data.frame(x = x_predict, .) %>% gather(pct, y, -x)
pfit <- ggplot() +
  geom_point(aes(Year, Number.of.victims), data = data_for_age_group, size = 1) +
  geom_line(aes(x, y, linetype = pct), data = mu, color = 'red') +
  scale_linetype_manual(values = c(2,1,2)) +
  labs(x = 'Year', y = 'Traffic deaths') +
  guides(linetype = F)
(pfit)
```



```{stan, output.var="stan_model_ar_pooled"}
data {
  int<lower=0> N;
  vector[N] y;
}
parameters {
  real alpha;
  real beta;
  real<lower=0> sigma;
}
transformed parameters {
  vector [N-1] mu;
  
  for (n in 2:N) {
    mu[n-1] = alpha + beta * y[n-1];
  }
}
model {
  for (n in 2:N) {
     y[n] ~ normal(mu[n-1], sigma);
  }
}
generated quantities {
  vector[N-1] log_lik;
  for (i in 2:N)
    log_lik[i-1] = normal_lpdf(y[i] | mu[i-1], sigma);
}
```

```{r}
pooled_data <- sapply(2009:2018, function (i) sum(filter(data, Year == i)$Number.of.victims))
pooled_data
```

```{r}

stan_data = list(
  N = 2018-2009+1,
  y = pooled_data
)
fit_pooled = sampling(stan_model_ar_pooled, data = stan_data, iter = 10000)
print(fit_pooled)
```



```{r}
samples_lin <- rstan::extract(fit_pooled, permuted = T)
```

```{r}
samples_lin <- rstan::extract(fit_pooled, permuted = T)
mu <- apply(samples_lin$mu, 2, quantile, c(0.05, 0.5, 0.95)) %>%
t() %>% data.frame(x = seq(2010,2018), .) %>% gather(pct, y, -x)
stan_data = list(x = seq(2010,2018), y = stan_data$y)
pfit <- ggplot() +
geom_point(aes(x, y), data = data.frame(stan_data), size = 1) + geom_line(aes(x, y, linetype = pct), data = mu, color = 'red') + scale_linetype_manual(values = c(2,1,2)) +
labs(y = 'Summer temp. @KilpisjaÌˆrvi', x= "Year") +
guides(linetype = F)
pfit
```

```{r}
log_lik_pooled <- extract_log_lik(fit_pooled, merge_chains = FALSE)

r_eff_pooled <- relative_eff(exp(log_lik_pooled)) 
loo_pooled <- loo(log_lik_pooled, r_eff = r_eff_pooled)
print(loo_pooled)
plot(loo_pooled)
```


```{stan, output.var="stan_model_ar_hierarchical"}
data {
  int<lower=0> N;
  int<lower=0> K; // number of groups
  int<lower=1,upper=K> x[N]; // group indicator
  vector[N] y;
}
parameters {
  real mu_group_alpha;
  real mu_group_beta;
  real<lower=0> tau_alpha; // prior std
  real<lower=0> tau_beta; // prior std
  vector[K] alpha;
  vector[K] beta;
  real<lower=0> sigma;
}
transformed parameters {
  vector [N-K] mu;
  
  for (n in K+1:N) {
    mu[n-K] = alpha[x[n]] + beta[x[n]] * y[n-K];
  }
}
model {
  alpha ~ normal(mu_group_alpha, tau_alpha);
  beta ~ normal(mu_group_beta, tau_beta);
  for (n in K+1:N) {
     y[n] ~ normal(mu[n-K], sigma);
  }
}
generated quantities {
  vector[N-K] log_lik;
  for (i in K+1:N)
    log_lik[i-K] = normal_lpdf(y[i] | mu[i-K], sigma);
}
```

```{r}
hierarchical_data <- sapply(2009:2018, function (j) sapply(1:11, function (i) filter(data, Victim.s.age == ageGroups[i] & Year == j)$Number.of.victims))
hierarchical_data
```

```{r}
rep(1:nrow(hierarchical_data), ncol(hierarchical_data))
```

```{r}
nrows <- nrow(hierarchical_data)
stan_data = list(
  N = (2018-2009+1) * 11,
  K = 11,
  x = rep(1:nrow(hierarchical_data), ncol(hierarchical_data)),
  y = c(t(hierarchical_data))
)
fit_hierarchical = sampling(stan_model_ar_hierarchical, data = stan_data, iter = 10000)
print(fit_hierarchical)
```


```{r}
log_lik_hierarchical <- extract_log_lik(fit_hierarchical, merge_chains = FALSE)

r_eff_hierarchical <- relative_eff(exp(log_lik_hierarchical)) 
loo_hierarchical<- loo(log_lik_hierarchical, r_eff = r_eff_hierarchical)
print(loo_hierarchical)
plot(loo_hierarchical)
```

// include proper prior, jusify

// Rhat convergence diagnostics

// HMC specific convergence diagnostics (divergences, tree depth)

// ESS diagnostics

// posterior predictive checking

### Model 2

// include proper prior, jusify

// Rhat convergence diagnostics

// HMC specific convergence diagnostics (divergences, tree depth)

// ESS diagnostics

// posterior predictive checking

## Problems encountered and potential improvements


# Conclusion

// a clear conclusion here
