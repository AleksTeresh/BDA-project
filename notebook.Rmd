---
title: "BDA-project"
output: pdf_document
---

```{r setup, include=FALSE}
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
 encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
```

# Loaded packages

```{r, echo=TRUE}
library(tidyr)
library(dplyr)
library(rstan)
library(rstanarm)
library(bayesplot)
library(aaltobda)
options(mc.cores = parallel::detectCores())
library(loo)
library(ggplot2)
library(gridExtra)
library(bayesplot)
```

# Introduction

// this part has to be inviting xD
// General talk about Finalnd having high rates of domestic violence, need to raise awareness, etc.

// Main topic/purpose of the project/notebook.

// Present outline of the notebook 

// structure and organization has to be logical

## Data description

## Analysis problem

## Models

// add a clear list of models

### Model 1

```{r}
data = read.csv("dataset.csv", header = TRUE, sep=";")
data
```

```{r}
ageGroups <- unique(data$Victim.s.age)
grouped_data <- c()


data_for_age_group <- filter(data, Victim.s.age == ageGroups[1])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[2])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[3])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[4])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[5])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[6])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[7])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[8])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[9])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[10])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

data_for_age_group <- filter(data, Victim.s.age == ageGroups[11])
ggplot(aes(Year, Number.of.victims), data = data_for_age_group) + geom_point(size = 1)  + geom_smooth()  

```

```{r}
data_for_age_group <- filter(data, Victim.s.age == ageGroups[7])
fit_lin <- stan_glm(Number.of.victims ~ Year, data = data_for_age_group , family="poisson",
                refresh=1000, iter=1000, chains=4, seed=583829)
print(fit_lin)
```

```{r}
x_predict <- seq(2009,2020)
N_predict <- length(x_predict)
y_predict <- posterior_predict(fit_lin, newdata=data.frame(Year=x_predict))
mu <- apply(t(y_predict), 1, quantile, c(0.05, 0.5, 0.95)) %>%
  t() %>% data.frame(x = x_predict, .) %>% gather(pct, y, -x)
pfit <- ggplot() +
  geom_point(aes(Year, Number.of.victims), data = data_for_age_group, size = 1) +
  geom_line(aes(x, y, linetype = pct), data = mu, color = 'red') +
  scale_linetype_manual(values = c(2,1,2)) +
  labs(x = 'Year', y = 'Traffic deaths') +
  guides(linetype = F)
(pfit)
```



```{stan, output.var="stan_model"}
data {
    int<lower=0> N; // number of data points
    vector[N] x;
    vector[N] y;
}
parameters {
    real alpha;
    real beta;
    real c;
    real<lower=0> sigma;
}
transformed parameters {
  vector[N] mu;
  
  for (i in 1:N) {
    mu[i] = alpha + beta * x[i] + c * x[i] * x[i];
  }
}
model {
  y ~ normal(mu, sigma); // observation for final numbers
}
```

```{r}
filtered_data <- filter(data, Victim.s.age == ageGroups[5])
stan_data = list(
  N = length(filtered_data$Year),
  x = filtered_data$Year - 2009,
  y = filtered_data$Number.of.victims
)
fit = sampling(stan_model, data = stan_data, seed = SEED)
```

```{r}
print(fit)
```

```{r}
 samples_lin <- rstan::extract(fit, permuted = T)
mean(samples_lin$beta>0) # probability that beta > 0s
```


```{r}
mu <- apply(samples_lin$mu, 2, quantile, c(0.05, 0.5, 0.95)) %>%
t() %>% data.frame(x = stan_data$x, .) %>% gather(pct, y, -x)
pfit <- ggplot() +
geom_point(aes(x, y), data = data.frame(stan_data), size = 1) + geom_line(aes(x, y, linetype = pct), data = mu, color = 'red') + scale_linetype_manual(values = c(2,1,2)) +
labs(y = 'Summer temp. @Kilpisjärvi', x= "Year") +
guides(linetype = F)
pfit
```

```{stan, output.var="stan_model_ar"}
data {
  int<lower=0> N;
  vector[N] y;
}
parameters {
  real alpha;
  real beta;
  real<lower=0> sigma;
}
transformed parameters {
  vector [N] mu ;
  
  mu[1] = y[1];
  for (n in 2:N) {
    mu[n] = alpha + beta * y[n-1];
  }
}
model {
  for (n in 2:N) {
     y[n] ~ normal(mu[n], sigma);
  }
}
```

```{r}
filtered_data <- filter(data, Victim.s.age == ageGroups[7])
stan_data = list(
  N = length(filtered_data$Year),
  y = filtered_data$Number.of.victims
)
fit = sampling(stan_model_ar, data = stan_data, seed = SEED, iter = 4000)
print(fit)
```



```{r}
samples_lin <- rstan::extract(fit, permuted = T)
```

```{r}
samples_lin <- rstan::extract(fit, permuted = T)
mu <- apply(samples_lin$mu, 2, quantile, c(0.05, 0.5, 0.95)) %>%
t() %>% data.frame(x = seq(2009,2018), .) %>% gather(pct, y, -x)
stan_data = list(x = seq(2009,2018), y = stan_data$y)
pfit <- ggplot() +
geom_point(aes(x, y), data = data.frame(stan_data), size = 1) + geom_line(aes(x, y, linetype = pct), data = mu, color = 'red') + scale_linetype_manual(values = c(2,1,2)) +
labs(y = 'Summer temp. @Kilpisjärvi', x= "Year") +
guides(linetype = F)
pfit
```

```{stan, output.var="stan_model_ma"}
data {
  int<lower=3> T;  // number of observations
  vector[T] y;     // observation at time T
}
parameters {
  real mu;              // mean
  real<lower=0> sigma;  // error scale
  vector[2] theta;      // lag coefficients
}
transformed parameters {
  vector[T] pred;
  vector[T] epsilon;    // error terms
  epsilon[1] = y[1] - mu;
  epsilon[2] = y[2] - mu - theta[1] * epsilon[1];
  
  pred[1] = mu;
  pred[2] = mu + theta[1] * epsilon[1];
  for (t in 3:T) {
    pred[t] = mu + theta[1] * epsilon[t - 1] + theta[2] * epsilon[t - 2];
    epsilon[t] = y[t] - pred[t];
  }
}
model {
  mu ~ normal(1750, 2000);
  for (t in 3:T)
    y[t] ~ normal(pred[t],
                  sigma);
}
```

```{r}
filtered_data <- filter(data, Victim.s.age == ageGroups[7])
stan_data = list(
  T = length(filtered_data$Year),
  y = filtered_data$Number.of.victims
)
fit = sampling(stan_model_ma, data = stan_data, iter = 10000)
print(fit)
```
```{r}
samples_lin <- rstan::extract(fit, permuted = T)
```


```{r}
pred <- apply(samples_lin$pred, 2, quantile, c(0.05, 0.5, 0.95)) %>%
t() %>% data.frame(x = seq(2009,2018), .) %>% gather(pct, y, -x)
stan_data = list(x = seq(2009,2018), y = stan_data$y)
pfit <- ggplot() +
geom_point(aes(x, y), data = data.frame(stan_data), size = 1) + geom_line(aes(x, y, linetype = pct), data = pred, color = 'red') + scale_linetype_manual(values = c(2,1,2)) +
labs(y = 'Summer temp. @Kilpisjärvi', x= "Year") +
guides(linetype = F)
pfit
```


```{stan, output.var="stan_model_arma"}
data {
  int<lower=1> T;            // num years
  int<lower=1> K;            // num of groups
  real y[K, T];                 // observed outputs
}
parameters {
  real mu[K];                   // mean coeff
  real phi[K];                  // autoregression coeff
  real theta[K];                // moving avg coeff
  real<lower=0> sigma[K];       // noise scale
}
transformed parameters {
  real nu[K, T];              // prediction for time t
  real err[K, T];             // error for time t
  real ypred[K, T];
  
  for (x in 1:K) {
    nu[x, 1] = mu[x] + phi[x] * mu[x];    // assume err[0] == 0
    err[x, 1] = y[x, 1] - nu[x, 1];
    nu[x, 2] = mu[x] + phi[x] * y[x, 1] + theta[x] * err[x, 1];
    err[x, 2] = y[x, 2] - nu[x, 2];
    
    ypred[x, 1] = nu[x, 1] + err[x, 1];
    ypred[x, 2] = nu[x, 2] + err[x, 2];
    for (t in 3:T) {
      nu[x, t] = mu[x] + phi[x] * y[x, t-1] + theta[x] * err[x, t-1] + theta[x] * err[x, t-2];
      err[x, t] = y[x, t] - nu[x, t];
      ypred[x, t] = nu[x, t] + err[x, t];
    }
  }
}
model {
  for (x in 1:K) {
    err[x] ~ normal(0, sigma[x]);    // likelihood
  }
}
```
```{r}
length(unique(data$Victim.s.age))
```


```{r}
filtered_data <- filter(data, Victim.s.age == ageGroups[7])
K = length(unique(data$Victim.s.age))

ys <- list()
for (i in 1:K) {
  ys <- c(ys, list(filter(data, Victim.s.age == ageGroups[i])$Number.of.victims))
}

ys
```

```{r}

stan_data = list(
  T = length(unique(data$Year)),
  K = K,
  y = ys
)
fit = sampling(stan_model_arma, data = stan_data, iter = 10000)
print(fit)
```

```{r}
samples_lin <- rstan::extract(fit, permuted = T)
stan_data$y[1]
```


```{r}
pred <- apply(matrix(matrix(samples_lin$nu, ncol=11)[,1], ncol=1), 2, quantile, c(0.05, 0.5, 0.95)) %>%
t() %>% data.frame(x = seq(2009,2018), .) %>% gather(pct, y, -x)
stan_data = list(x = seq(2009,2018), y = stan_data$y[1])
pfit <- ggplot() +
geom_point(aes(x, y), data = data.frame(stan_data), size = 1) + geom_line(aes(x, y, linetype = pct), data = pred, color = 'red') + scale_linetype_manual(values = c(2,1,2)) +
labs(y = 'Summer temp. @Kilpisjärvi', x= "Year") +
guides(linetype = F)
pfit
```

// include proper prior, jusify

// Rhat convergence diagnostics

// HMC specific convergence diagnostics (divergences, tree depth)

// ESS diagnostics

// posterior predictive checking

### Model 2

// include proper prior, jusify

// Rhat convergence diagnostics

// HMC specific convergence diagnostics (divergences, tree depth)

// ESS diagnostics

// posterior predictive checking

## Problems encountered and potential improvements


# Conclusion

// a clear conclusion here
